$(function () {
	setInterval(function() {
    	$("#navbarNav .pulsed").toggleClass("pulsedred");
	},700)
    if(window.location.hash) {
        var anchor = window.location.hash;
        if(anchor == '#questionPopup') {
            $('.help-banner-body .btn').trigger('click');
        }
    }
    $('.grid-banner[href*="#questionPopup"]').click(function (e) {
         e.preventDefault();
        $('.help-banner-body .btn').trigger('click');
    })

    // tips
    $('.tips_more').click(function (e) {
        e.preventDefault();
        var section = $(this).data('section');
        tipsShow[section] = tipsShow[section] + tipsStep[section];
        if( tipsShow[section] >= tipsCnt[section] )
            $('.tips_more[data-section='+section+']').remove();

        for( var i = 0; i < tipsShow[section]; i++ )
        {
            $('.tips-section-'+section+' .col-md-4.col-xl-4').eq(i).removeClass('hidden_item');
            $('.tips-section-'+section+' .col-md-3.col-xl-3').eq(i).removeClass('hidden_item');
        }
    });

    // ratings category goods
    $('.rgoods-more').click(function (e) {
        e.preventDefault();
        var section = $(this).data('section');
        rGoodsShow[section] = rGoodsShow[section] + rGoodsStep[section];
        if( rGoodsShow[section] >= rGoodsCnt[section] )
            $('.rgoods-more[data-section='+section+']').remove();

        for( var i = 0; i < rGoodsShow[section]; i++ )
        {
            $('.rgoods-section-'+section+' .rgoods-item').eq(i).removeClass('hidden_item');
        }
    });

    // tags on tips
    $('.more-tags-tips').click(function (e) {
        e.preventDefault();
        var section = $(this).data('section-id');
        tagsShow[section] = tagsShow[section] + tagsStep[section];

        for( var i = 0; i < tagsShow[section]; i++ )
        {
            $('.tags-tips-'+section+' li').eq(i).removeClass('hidden_item');
        }
    });

    $('.clear-tags-tips').click(function (e) {
        e.preventDefault();
        var section = $(this).data('section-id');
        tagsShow[section] = tagsStartShow[section];

        for( var i = tagsShow[section]; i < tagsCnt[section]; i++ )
        {
            $('.tags-tips-'+section+' li').eq(i).addClass('hidden_item');
        }

        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'tags_tips', section_id: section, consumer: consumer},
            function (data) {
                if( data.status ) {
                    $('.tips-section-'+section).html(data.data);
                    $('.clear-tags-tips[data-section-id='+section+']').hide();
                    // reuse: tips
                    $('.tips_more').click(function (e) {
                        e.preventDefault();
                        var section = $(this).data('section');
                        tipsShow[section] = tipsShow[section] + tipsStep[section];
                        if( tipsShow[section] >= tipsCnt[section] )
                            $('.tips_more[data-section='+section+']').remove();

                        for( var i = 0; i < tipsShow[section]; i++ )
                        {
                            $('.tips-section-'+section+' .col-md-3.col-xl-3').eq(i).removeClass('hidden_item');
                            $('.tips-section-'+section+' .col-md-4.col-xl-4').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('.tags-tips a').click(function (e) {
        e.preventDefault();
        var section = $(this).data('section-id');
        var idd = $(this).data('tag-id');
        var ids = [];
        $('.tags-tips .active').each(function(i, e){
            ids.push($(this).data('tag-id'));
        });

        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'tags_tips', tag_id: ids.join(), section_id: section, consumer: consumer},
            function (data) {
                if( data.status ) {
                    $('.tips-section-'+section).html(data.data);
                    if( ids.length > 0 ) {
                        $('.clear-tags-tips[data-section-id='+section+']').show();
                    } else {
                        $('.clear-tags-tips[data-section-id='+section+']').hide();
                    }
                    // reuse: tips
                    $('.tips_more').click(function (e) {
                        e.preventDefault();
                        var section = $(this).data('section');
                        tipsShow[section] = tipsShow[section] + tipsStep[section];
                        if( tipsShow[section] >= tipsCnt[section] )
                            $('.tips_more[data-section='+section+']').remove();

                        for( var i = 0; i < tipsShow[section]; i++ )
                        {
                            $('.tips-section-'+section+' .col-md-3.col-xl-3').eq(i).removeClass('hidden_item');
                            $('.tips-section-'+section+' .col-md-4.col-xl-4').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
        return false;
    });

    // news
    $('.news_more').click(function (e) {
        e.preventDefault();
        newsShow = newsShow + newsStep;
        if( newsShow >= newsCnt )
            $('.news_more').remove();

        for( var i = 0; i < newsShow; i++ )
        {
            $('.news-item').eq(i).removeClass('hidden_item');
        }
    });
    // news2 (goods)
    $('.news2_more').click(function (e) {
        e.preventDefault();
        news2Show = news2Show + news2Step;
        if( news2Show >= news2Cnt )
            $('.news2_more').remove();

        for( var i = 0; i < news2Show; i++ )
        {
            if( $('.news2-item').eq(i).hasClass('hidden_item') ) {
                $('.news2-item').eq(i).addClass('lazy-item');
            }
            $('.news2-item').eq(i).removeClass('hidden_item');

        }

        $('.lazy-item .card-img-top').lazy({
            bind: "event",
            effect: 'fadeIn',
            visibleOnly: true,
            delay: 0,
            afterLoad: function(element) {
                element.parent().addClass('loaded');
            },
        });
    });

    // news on main
    $('.more-news-main').click(function (e) {
        e.preventDefault();
        if( newsShow >= 6 ) {
            newsStep = 4;
        }
        newsShow = newsShow + newsStep;
        if( newsShow >= newsCnt )
            $('.more-news-main').remove();

        for( var i = 0; i < newsShow; i++ )
        {
            if( $('.news-main-item').eq(i).hasClass('hidden_item') ) {
                $('.news-main-item').eq(i).addClass('lazy-item');
            }
            $('.news-main-item').eq(i).removeClass('hidden_item');
        }

        $('.lazy-item .card-img-top').lazy({
            bind: "event",
            effect: 'fadeIn',
            visibleOnly: true,
            delay: 0,
            afterLoad: function(element) {
                element.parent().addClass('loaded');
            },
        });
    });

    // tags on main
    $('.more-tags-main').click(function (e) {
        e.preventDefault();
        tagsShow = tagsShow + tagsStep;

        for( var i = 0; i < tagsShow; i++ )
        {
            $('.tags-main li').eq(i).removeClass('hidden_item');
        }
    });

    $('.clear-tags-main').click(function (e) {
        e.preventDefault();
        tagsShow = tagsStartShow;

        for( var i = tagsShow; i < tagsCnt; i++ )
        {
            $('.tags-main li').eq(i).addClass('hidden_item');
        }
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'tags_main'},
            function (data) {
                if( data.status ) {
                    $('.news-main').replaceWith(data.data);
                    $('.clear-tags-main').hide();
                    // reuse: tags on main
                    $('.more-news-main').click(function (e) {
                        e.preventDefault();
                        newsShow = newsShow + newsStep;
                        if( newsShow >= newsCnt )
                            $('.more-news-main').remove();

                        for( var i = 0; i < newsShow; i++ )
                        {
                            if( $('.news-main-item').eq(i).hasClass('hidden_item') ) {
                                $('.news-main-item').eq(i).addClass('lazy-item');
                            }
                            $('.news-main-item').eq(i).removeClass('hidden_item');
                        }

                        $('.lazy-item .card-img-top').lazy({
                            bind: "event",
                            effect: 'fadeIn',
                            visibleOnly: true,
                            delay: 0,
                            afterLoad: function(element) {
                                element.parent().addClass('loaded');
                            },
                        });
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('.tags-main a').click(function (e) {
        e.preventDefault();
        var idd = $(this).data('tag-id');
        var ids = [];
        $('.tags-main a.active').each(function(i, e){
            ids.push($(this).data('tag-id'));
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'tags_main', tag_id: ids.join()},
            function (data) {
                if( data.status ) {
                    $('.news-main').replaceWith(data.data);
                    if( ids.length > 0 ) {
                        $('.clear-tags-main').show();
                    } else {
                        $('.clear-tags-main').hide();
                    }
                    // reuse: tags on main
                    $('.more-news-main').click(function (e) {
                        e.preventDefault();
                        newsShow = newsShow + newsStep;
                        if( newsShow >= newsCnt )
                            $('.more-news-main').remove();

                        for( var i = 0; i < newsShow; i++ )
                        {
                            if( $('.news-main-item').eq(i).hasClass('hidden_item') ) {
                                $('.news-main-item').eq(i).addClass('lazy-item');
                            }
                            $('.news-main-item').eq(i).removeClass('hidden_item');
                        }

                        $('.lazy-item .card-img-top').lazy({
                            bind: "event",
                            effect: 'fadeIn',
                            visibleOnly: true,
                            delay: 0,
                            afterLoad: function(element) {
                                element.parent().addClass('loaded');
                            },
                        });
                    });
                } else {

                }
            },
            "json"
        );
        return false;
    });











    //consumer_rights
    var cr_page = 2;
    function consumer_rights(){
        $('.more-news-consumer_rights').one( "click", function (e) {
            e.preventDefault();
            var ids = [];
            $('.tags-consumer_rights a.active').each(function(i, e){
                ids.push($(this).data('tag-id'));
            });
            $.post(
                "/local/templates/main/include/ajax.php",
                {action: 'tags_consumer_rights', tag_id: ids.join(), ib_id: tags_iblocks, page: cr_page, start_page_size: start_page_size, page_size: page_size, columns: columns},
                function (data) {
                    if( data.status ) {
                        $('.news-consumer_rights-items').append($(data.data).find('.news-consumer_rights-items').html());
                        $('.more-news-consumer_rights').replaceWith($(data.data).find('.more-news-consumer_rights'));
                        consumer_rights();
                        if( ids.length > 0 ) {
                            $('.clear-tags-consumer_rights').show();
                        } else {
                            $('.clear-tags-consumer_rights').hide();
                        }
                        cr_page++;
                    } else {

                    }
                },
                "json"
            );
            return false;

            $('.lazy-item .card-img-top').lazy({
                bind: "event",
                effect: 'fadeIn',
                visibleOnly: true,
                delay: 0,
                afterLoad: function(element) {
                    element.parent().addClass('loaded');
                },
            });
        });


        //popup iframe video
        $(document).ready(function() {
           $('.popup-video-consumer_rights').magnificPopup({
              type: 'iframe',
            });
           $('.popup-video-other-consumer_rights').magnificPopup({
                type: 'inline',
                callbacks: {
                    beforeOpen: function() {
                        this.st.mainClass = 'mfp-iframe-holder';
                    }
                }
            })
        });


    }
    consumer_rights();


    $('.more-tags-consumer_rights').click(function (e) {
        e.preventDefault();
        tagsShow = tagsShow + tagsStep;

        for( var i = 0; i < tagsShow; i++ )
        {
            $('.tags-consumer_rights li').eq(i).removeClass('hidden_item');
        }

        if($('.tags-consumer_rights li.hidden_item').length == 0){$('.more-tags-consumer_rights').hide();}else{$('.more-tags-consumer_rights').show();}
    });

    $('.clear-tags-consumer_rights').click(function (e) {
        e.preventDefault();
        tagsShow = tagsStartShow;

        for( var i = tagsShow; i < tagsCnt; i++ )
        {
            $('.tags-consumer_rights li').eq(i).addClass('hidden_item');
        }

        if($('.tags-consumer_rights li.hidden_item').length == 0){$('.more-tags-consumer_rights').hide();}else{$('.more-tags-consumer_rights').show();}

        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'tags_consumer_rights', ib_id: tags_iblocks, page: '1', start_page_size: start_page_size, page_size: page_size},
            function (data) {
                if( data.status ) {
                    $('.news-consumer_rights').replaceWith(data.data);
                    $('.clear-tags-consumer_rights').hide();
                    cr_page = 2;
                    consumer_rights();
                } else {

                }
            },
            "json"
        );
    });

    $('.tags-consumer_rights a').click(function (e) {
        e.preventDefault();
        var idd = $(this).data('tag-id');
        var ids = [];
        $('.tags-consumer_rights a.active').each(function(i, e){
            ids.push($(this).data('tag-id'));
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'tags_consumer_rights', tag_id: ids.join(), ib_id: tags_iblocks, page: '1', start_page_size: start_page_size, page_size: page_size},
            function (data) {
                if( data.status ) {
                    $('.news-consumer_rights').replaceWith(data.data);
                    consumer_rights();
                    cr_page = 2;
                    if( ids.length > 0 ) {
                        $('.clear-tags-consumer_rights').show();
                    } else {
                        $('.clear-tags-consumer_rights').hide();
                    }
                    // reuse: tags on main
                } else {

                }
            },
            "json"
        );
        return false;
    });







    // goods on rating
    $('.rating-more-goods').click(function (e) {
        e.preventDefault();
        goodsShow = goodsShow + goodsStep;
        if( goodsShow >= goodsCnt )
            $('.rating-more-goods').remove();

        for( var i = 0; i < goodsShow; i++ )
        {
            $('.product-row .product').eq(i).removeClass('hidden_item');
        }
    });

    // news on rating
    $('.rating-more-news').click(function (e) {
        e.preventDefault();
        newsShow = newsShow + newsStep;
        if( newsShow >= newsCnt )
            $('.rating-more-news').remove();

        for( var i = 0; i < newsShow; i++ )
        {
            $('.rating-news .new').eq(i).removeClass('hidden_item');
        }
    });

    // login form
    $('#loginForm').on('submit', function (e) {
        var email = $('#loginForm input[name=loginEmail]').val();
        var password = $('#loginForm input[name=loginPassword]').val();
        $('#loginForm p.error___p').html('');
        var error = false;
        if( email.length == 0 ) {
            error = true;
        }
        if( password.length == 0 ) {
            error = true;
        }
        if( error ) {
            return false;
        }
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'auth', email: email, password: password},
            function (data) {
                if( data.status ) {
                    location.reload();
                } else {
                    $('#loginForm p.error___p').html(data.message);
                }

            },
            "json"
        );
        return false;
    });

    // register form
    $('#registerForm').on('submit', function (e) {
        var email = $('#registerForm input[name=registerEmail]').val();
        var password = $('#registerForm input[name=registerPassword]').val();
        var agree = $("#registerForm input[name=regRules]:checked").val();
        var sub = $("#registerForm input[name=sub]:checked").val();
        $('#registerForm p.error___p').html('');
        var error = false;
        if( email.length == 0 ) {
            error = true;
        }
        if( password.length == 0 ) {
            error = true;
        }
        if( !agree ) {
            error = true;
        }
        if( error ) {
            return false;
        }
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'register', email: email, password: password, sub: sub},
            function (data) {
                if( data.status ) {
                    //document.location = document.location;
                    $.magnificPopup.open({
                        items: {
                            src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>РЕГИСТРАЦИЯ УСПЕШНО ПРОВЕДЕНА</h2><p>На ваш электронный адрес направлено письмо с подтверждением. Для завершения регистрации, перейдите на ваш электронный адрес и следуйте инструкциям, которые обозначенны в письме.</p> <span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                            type: 'inline'
                        },
                        removalDelay: 500,
                        callbacks: {
                            beforeOpen: function() {
                                this.st.mainClass = 'mfp-move-from-top';
                            }
                        }
                    });
                    ym(31284483,'reachGoal','registration');
                } else {
                    $('#registerForm p.error___p').html(data.message);
                }

            },
            "json"
        );
        return false;
    });

    // filters on rating
    $('#vue-rating, #ajax-filter').find('.sidebar-widget select').each(function(indx, element){
        $(element).select2('destroy');
        var parent = $(element).closest('.sidebar-widget');
        $(element).select2({
            minimumResultsForSearch: Infinity,
            dropdownParent: parent
        });
    })


    $('select[name=select-rating]').on('change', function(){
        var ids = [];
        $('.brands .filter-checkbox:checked').each(function(i, e){
            ids.push($(this).val());
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $(this).val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $('select[name=select-rating3]').val(),
                brands: ids.join(),
                areas: $('select[name=select-rating-areas]').val(),
                versions: $('input[type=radio][name=os-type]:checked').val()
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('select[name=select-rating2]').on('change', function(){
        var ids = [];
        $('.brands .filter-checkbox:checked').each(function(i, e){
            ids.push($(this).val());
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $(this).val(),
                all: $('select[name=select-rating3]').val(),
                brands: ids.join(),
                areas: $('select[name=select-rating-areas]').val(),
                versions: $('input[type=radio][name=os-type]:checked').val()
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('select[name=select-rating3]').on('change', function(){
        var ids = [];
        $('.brands .filter-checkbox:checked').each(function(i, e){
            ids.push($(this).val());
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $(this).val(),
                brands: ids.join(),
                areas: $('select[name=select-rating-areas]').val(),
                versions: $('input[type=radio][name=os-type]:checked').val()
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('#ajax-filter').find('.brands .filter-checkbox, #widget-props-filter :input').on('change',  function(){
        var filter_data, props_filters={}, ids = [];
        $('.brands .filter-checkbox:checked').each(function(i, e){
            ids.push($(this).val());
        });

        filter_data = {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $('select[name=select-rating3]').val(),
                brands: ids.join(),
                areas: $('select[name=select-rating-areas]').val(),
                versions: $('input[type=radio][name=os-type]:checked').val()
        };

        props_filters = $('#widget-props-filter :input').serializeArray();
        if (props_filters.length) {
            filter_data['props_filter'] = $.param(props_filters);
        }
        $.post(
            "/local/templates/main/include/ajax.php",
            filter_data,
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('#ajax-filter').find('.brands .js-reset-all').on('click', function (e) {
        e.preventDefault();
        $('.brands .filter-checkbox:checked').each(function(i, e){
            $(this).prop('checked', false);
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $('select[name=select-rating3]').val(),
                brands: '',
                areas: $('select[name=select-rating-areas]').val(),
                versions: $('input[type=radio][name=os-type]:checked').val()
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('input[name=brandSearch]').on('keyup', function () {
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_brands',
                rating_id: $('input[name=rating_id]').val(),
                search: $(this).val()
            },
            function (data) {
                if( data.status ) {

                    $('.brands .filter-checkbox').each(function(i, e){
                        var idd = $(this).parent().parent().data('id');
                        if( jQuery.inArray(idd, data.data) != -1 ) {
                            $('[data-id='+idd+']').show();
                        } else {
                            $('[data-id='+idd+']').hide();
                        }
                    });

                } else {

                }
            },
            "json"
        );
    });

    $('.areas .filter-checkbox').on('change',  function(){
        var ids = [];
        $('.areas .filter-checkbox:checked').each(function(i, e){
            ids.push($(this).val());
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $('select[name=select-rating3]').val(),
                areas: ids.join()
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });


    $('select[name=select-rating-areas]').on('change', function(){
        var ids = [];
        $('.brands .filter-checkbox:checked').each(function(i, e){
            ids.push($(this).val());
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $('select[name=select-rating3]').val(),
                brands: ids.join(),
                areas: $(this).val()
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('.versions .filter-checkbox').on('change',  function(){
        var ids = [];
        $('.versions .filter-checkbox:checked').each(function(i, e){
            ids.push($(this).val());
        });
        var ids2 = [];
        $('.brands .filter-checkbox:checked').each(function(i, e){
            ids2.push($(this).val());
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $('select[name=select-rating3]').val(),
                brands: ids2.join(),
                versions: ids.join()
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });


    /*$('select[name=select-rating-versions]').on('change', function(){
        //console.log($(this).val());
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $('select[name=select-rating3]').val(),
                versions: $(this).val()
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });*/
    $('input[type=radio][name=os-type]').change(function() {
        var value = $('input[type=radio][name=os-type]:checked').val();

        $('.brands .filter-checkbox:checked').each(function(i, e){
            //ids.push($(this).val());
            $(this).prop('checked', false);
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'rating_goods',
                rating_id: $('input[name=rating_id]').val(),
                sortby: $('select[name=select-rating]').val(),
                orderby: $('select[name=select-rating2]').val(),
                all: $('select[name=select-rating3]').val(),
                brands: '',
                versions: value
            },
            function (data) {
                if( data.status ) {
                    $('.rating-goods .product-row').replaceWith(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    // goods


    // filters on goods
    $('select[name=select-goods]').on('change', function(){
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'goods',
                sortby: $(this).val(),
                orderby: $('select[name=select-goods2]').val(),
                all: $('select[name=select-goods3]').val()
            },
            function (data) {
                if( data.status ) {
                    $('.product-row-goods').html(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('select[name=select-goods2]').on('change', function(){
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'goods',
                sortby: $('select[name=select-goods]').val(),
                orderby: $(this).val(),
                all: $('select[name=select-goods3]').val()
            },
            function (data) {
                if( data.status ) {
                    $('.product-row-goods').html(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('select[name=select-goods3]').on('change', function(){
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'goods',
                sortby: $('select[name=select-goods]').val(),
                orderby: $('select[name=select-goods2]').val(),
                all: $(this).val()
            },
            function (data) {
                if( data.status ) {
                    $('.product-row-goods').html(data.data);
                    $('.rating-more-goods').click(function (e) {
                        e.preventDefault();
                        goodsShow = goodsShow + goodsStep;
                        if( goodsShow >= goodsCnt )
                            $('.rating-more-goods').remove();

                        for( var i = 0; i < goodsShow; i++ )
                        {
                            $('.product-row .product').eq(i).removeClass('hidden_item');
                        }
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('.filter-checkbox-goods').on('change',  function(){
        var ids = [];
        $('#widget-brand .filter-checkbox-goods:checked').each(function(i, e){
            ids.push($(this).val());
        });
        var ids2 = [];
        $('#widget-category .filter-checkbox-goods:checked').each(function(i, e){
            ids2.push($(this).val());
        });
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'goods',
                sortby: $('select[name=select-goods]').val(),
                orderby: $('select[name=select-goods2]').val(),
                all: $('select[name=select-goods3]').val(),
                brands: ids.join(),
                categories: ids2.join()
            },
            function (data) {
                if( data.status ) {
                    $('.product-row-goods').html(data.data);
                    $('.product-row-goods').html(data.data);
                    if( news2Show >= news2Cnt )
                        $('.news2_more').remove();

                    for( var i = 0; i < news2Show; i++ )
                    {
                        if( $('.news2-item').eq(i).hasClass('hidden_item') ) {
                            $('.news2-item').eq(i).addClass('lazy-item');
                        }
                        $('.news2-item').eq(i).removeClass('hidden_item');

                    }

                    $('.lazy-item .card-img-top').lazy({
                        bind: "event",
                        effect: 'fadeIn',
                        visibleOnly: true,
                        delay: 0,
                        afterLoad: function(element) {
                            element.parent().addClass('loaded');
                        },
                    });
                    // news2 (goods)
                    $('.news2_more').click(function (e) {
                        e.preventDefault();
                        news2Show = news2Show + news2Step;
                        if( news2Show >= news2Cnt )
                            $('.news2_more').remove();

                        for( var i = 0; i < news2Show; i++ )
                        {
                            if( $('.news2-item').eq(i).hasClass('hidden_item') ) {
                                $('.news2-item').eq(i).addClass('lazy-item');
                        }
                            $('.news2-item').eq(i).removeClass('hidden_item');

                        }

                        $('.lazy-item .card-img-top').lazy({
                            bind: "event",
                            effect: 'fadeIn',
                            visibleOnly: true,
                            delay: 0,
                            afterLoad: function(element) {
                                element.parent().addClass('loaded');
                            },
                        });
                    });
                } else {

                }
            },
            "json"
        );
    });

    $('input[name=brandSearchGoods]').on('keyup', function () {
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'goods_brands',
                search: $(this).val()
            },
            function (data) {
                if( data.status ) {

                    $('.brands .filter-checkbox-goods').each(function(i, e){
                        var idd = $(this).parent().parent().data('id');
                        if( jQuery.inArray(idd, data.data) != -1 ) {
                            $('[data-id='+idd+']').show();
                        } else {
                            $('[data-id='+idd+']').hide();
                        }
                    });

                } else {

                }
            },
            "json"
        );
    });

    // sharing
    $('.b-share-fb').click(function(e){
        e.preventDefault();
        var title = $(this).attr('data-share-title') || document.title;
        var image = $(this).attr('data-share-image') || '';
        var text = $(this).attr('data-share-text') || '';
        var u = $(this).attr('data-share-url') || document.location.href;

        url = 'https://www.facebook.com/sharer.php?u=' + encodeURIComponent(u);
        window.open(url, '', 'toolbar=0,status=0,width=626,height=436');
    });

    $('.b-share-vk').click(function(e){
        e.preventDefault();
        var title = $(this).attr('data-share-title') || document.title;
        var image = $(this).attr('data-share-image') || '';
        var text = $(this).attr('data-share-text') || '';
        var u = $(this).attr('data-share-url') || document.location.href;

        url = 'https://vk.com/share.php';
        url += '?url=' + encodeURIComponent(u);
        url += '&title=' + encodeURIComponent(title);
        url += '&description=' + encodeURIComponent(text);
        url += '&image=' + encodeURIComponent(image);
        url += '&noparse=true';

        window.open(url, '', 'toolbar=0,status=0,width=626,height=436');
    });

    $('.b-share-tw').click(function(e){
        e.preventDefault();
        var title = $(this).attr('data-share-title') || document.title;
        var image = $(this).attr('data-share-image') || '';
        var text = $(this).attr('data-share-text') || '';
        var u = $(this).attr('data-share-url') || document.location.href;

        url = 'https://twitter.com/share';
        url += '?url=' + encodeURIComponent(u);
        url += '&text=' + encodeURIComponent(text);

        window.open(url, '', 'toolbar=0,status=0,width=626,height=436');
    });

    $('.b-share-ok').click(function(e){
        e.preventDefault();
        var title = $(this).attr('data-share-title') || document.title;
        var image = $(this).attr('data-share-image') || '';
        var text = $(this).attr('data-share-text') || '';
        var u = $(this).attr('data-share-url') || document.location.href;

        var url = 'https://connect.ok.ru/offer';
        url += '?url=' + encodeURIComponent(u);
        url += '&title=' + encodeURIComponent(title);
        url += '&imageUrl=' + encodeURIComponent(image);

        window.open(url, '', 'toolbar=0,status=0,width=626,height=436');
    });

    // subscribe
    $('.form-subscribe').on('submit', function (e) {
        var isPopup = $(this).is("#articlePopup");
        $('.form-subscribe input[type=text]').css('border-color','#0c339f');
        var email = $(this).find('input[type=text]').val();
        var error = false;
        if( email.length == 0 ) {
            error = true;
            $('.form-subscribe input[type=text]').css('border-color', 'red');
        }

        var form_goal = $('.form-subscribe input[name="form_goal"]').val();
        var popupSubscr_form = $('.form-subscribe input[name="popupSubscr_form"]').val();

        if( ! error ) {
            $.post(
                "/local/templates/main/include/ajax.php",
                {
                    action: 'subscribe',
                    email: email
                },
                function (data) {
                    if( data.status ) {
                        if(isPopup){
                            data.message2 = "Доступ к&nbsp;материалу разрешен!";
                            data.message = "Вы успешно подписались на&nbsp;рассылку. Спасибо, что вы с нами.";
                        }
                        $('.form-subscribe input[type=text]').val('');
                        $.magnificPopup.open({
                            items: {
                                src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>'+data.message2+'</h2><p>'+data.message+'</p><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                                type: 'inline'
                            },
                            removalDelay: 500,
                            callbacks: {
                                beforeOpen: function() {
                                    this.st.mainClass = 'mfp-move-from-top';
                                }
                            }
                        });
                        $('.subscribeBlock, .subscribeBlockFixed').remove();
                        Cookies.set('close_subscribe', true, { expires: 1095 });
                        Cookies.set('subscribeEmail', true, { expires: 1095 });

                        hideArticleSubscrOnly();

                        ym(31284483,'reachGoal','new_research');
                        ym(31284483,'reachGoal',form_goal);
                        ym(31284483,'reachGoal',popupSubscr_form);

                        if(isPopup){
                            setTimeout(function () {
                                $.magnificPopup.close();
                            }, 3000);
                        }

                    } else {
                        if(isPopup){
                            data.message2 = "Доступ к&nbsp;материалу разрешен!";
                            if(data.type == "new_subscriber"){
                                data.message = "Вы успешно подписались на рассылку. Спасибо, что вы с нами.";
                            } else if(data.type == "activate"){
                                data.message = "Подписка возобновлена. Спасибо, что вы с нами.";
                            }
                        }
                        $.magnificPopup.open({
                            items: {
                                src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>'+data.message2+'</h2><p>'+data.message+'</p><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                                type: 'inline'
                            },
                            removalDelay: 500,
                            callbacks: {
                                beforeOpen: function() {
                                    this.st.mainClass = 'mfp-move-from-top';
                                }
                            }
                        });
                        if(isPopup){
                            setTimeout(function () {
                                $.magnificPopup.close();
                            }, 3000);
                        }

						if(data.type !== "incorrect_email"){
                           Cookies.set('subscribeEmail', true, { expires: 1095 });
                           Cookies.set('close_subscribe', true, { expires: 1095 });
                           hideArticleSubscrOnly();
                           addCloseSidebarSubscBtn();
                           $(".subscribeBlock, .subscribeBlockFixed").remove();
						}

                    }
                },
                "json"
            );
        }
        return false;
    });

    function showSubscribe(){
        if (Cookies.get('close_subscribe'))
            return true;

        if ($('#subscribe-popup2').length) {
            $.magnificPopup.open({
                items: {
                    src: '#subscribe-popup2'
                },
                removalDelay: 500,
                callbacks: {
                    beforeOpen: function () {
                        this.st.mainClass = 'mfp-move-from-top';
                        Cookies.set('close_subscribe', true, { expires: 7 });
                    },
                    close: function() {
                    }
                },
                type: 'inline'
            });
        }
    }

    if (typeof Cookies !== 'undefined') {
        if(!Cookies.get('close_subscribe')){
            if (window.location.search.indexOf('utm_source=email') > 0) {
                Cookies.set('close_subscribe', true, { expires: 1095 });
            }
            else {
                setTimeout(function () {
                    showSubscribe();
                }, 60000);
            }
        }
        if(!Cookies.get('subscribeEmail')){
            if (window.location.search.indexOf('utm_source=email') > 0) {
                Cookies.set('subscribeEmail', true, { expires: 1095 });
                hideArticleSubscrOnly();
            }
        }
    }

    $('.form-subscribe-main').on('submit', function (e) {
        $('.form-subscribe-main input[type=text]').css('border-color','#0c339f');
        var email = $('.form-subscribe-main input[type=text]').val();
        var error = false;
        if( email.length == 0 ) {
            error = true;
            $('.form-subscribe-main input[type=text]').css('border-color', 'red');
        }

        if( ! error ) {
            $.post(
                "/local/templates/main/include/ajax.php",
                {
                    action: 'subscribe',
                    email: email
                },
                function (data) {
                    if( data.status ) {
                        $('.form-subscribe-main input[type=text]').val('');
                        $.magnificPopup.open({
                            items: {
                                src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>Вы успешно подписались на рассылку</h2><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                                type: 'inline'
                            },
                            removalDelay: 500,
                            callbacks: {
                                beforeOpen: function() {
                                    this.st.mainClass = 'mfp-move-from-top';
                                }
                            }
                        });
                    } else {
                        $.magnificPopup.open({
                            items: {
                                src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>Ошибка подписки на рассылку</h2><p>'+data.message+'</p><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                                type: 'inline'
                            },
                            removalDelay: 500,
                            callbacks: {
                                beforeOpen: function() {
                                    this.st.mainClass = 'mfp-move-from-top';
                                }
                            }
                        });
                    }
                },
                "json"
            );
        }
        return false;
    });
    $('.subscribeRules').on('change',  function(){
        if( !$(this).prop('checked') ) {
            $('.form-subscribe-small input[type=submit]').prop('disabled', true);
        } else {
            $('.form-subscribe-small input[type=submit]').prop('disabled', false);
        }
    });
    $('.form-subscribe-small').on('submit', function (e) {
        $('.form-subscribe-small input[type=text]').css('border-color','#0c339f');
        var email = $('.form-subscribe-small input[type=text]').val();
        var error = false;
        if( email.length == 0 ) {
            error = true;
            $('.form-subscribe-small input[type=text]').css('border-color', 'red');
        }

        if( ! error ) {
            $.post(
                "/local/templates/main/include/ajax.php",
                {
                    action: 'subscribe',
                    email: email
                },
                function (data) {
                    if( data.status ) {
                        $('.form-subscribe-small input[type=text]').val('');
                        $.magnificPopup.open({
                            items: {
                                src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>Вы успешно подписались на рассылку</h2><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                                type: 'inline'
                            },
                            removalDelay: 500,
                            callbacks: {
                                beforeOpen: function() {
                                    this.st.mainClass = 'mfp-move-from-top';
                                }
                            }
                        });
                        ym(31284483,'reachGoal','new_content');
                    } else {
                        $.magnificPopup.open({
                            items: {
                                src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>Ошибка подписки на рассылку</h2><p>'+data.message+'</p><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                                type: 'inline'
                            },
                            removalDelay: 500,
                            callbacks: {
                                beforeOpen: function() {
                                    this.st.mainClass = 'mfp-move-from-top';
                                }
                            }
                        });
                    }
                },
                "json"
            );
        }
        return false;
    });

    // form poll
    $('.form-poll').click(function (e) {
        e.preventDefault();
        // if( $(this).data('already') != "1" ) {
        //     $(this).data('already', '1');
        //     $(this).html('Вы уже ответили')
        //     $.magnificPopup.open({
        //         items: {
        //             src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>Благодарим за активность в опросе!</h2><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
        //             type: 'inline'
        //         },
        //         removalDelay: 500,
        //         callbacks: {
        //             beforeOpen: function() {
        //                 this.st.mainClass = 'mfp-move-from-top';
        //             }
        //         }
        //     });
        // } else {
        //
        // }
        var poll_id = $(this).data('poll-id');
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'vote',
                poll_id: poll_id,
                variant: $('.poll input[name=questionRadio]:checked').val()
            },
            function (data) {
                if( data.status ) {
                    $('.form-poll').html('Вы ответили');
                } else {
                    $('.form-poll').html('Вы уже голосовали ранее');
                }
            },
            "json"
        );
    });

    // compare short
    $(document).on('click', '.js-add-compare-2', function (e) {
        e.preventDefault();
        var good_id = $(this).data('good-id');
        var rating_id = $('.rating-id').data('rating-id');
        var show_compare_btn = $(this).data('show-compare-btn');
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'compare_add',
                rating_id: rating_id,
                good_id: good_id,
                show_compare_btn: show_compare_btn
            },
            function (data) {
                if( data.status ) {

                    $('#comparePopupShort').html(data.data);

                    $.magnificPopup.open({
                        items: {
                            src: '#comparePopupShort',
                            type: 'inline'
                        },
                        removalDelay: 500,
                        callbacks: {
                            beforeOpen: function() {
                                this.st.mainClass = 'mfp-move-from-top fixed';
                            }
                        }
                    });

                } else {

                }
            },
            "json"
        );
    });

    // favorites
    $('.heading-favorite').click(function (e) {
        e.preventDefault();
        var record_id = $(this).data('record-id');
        var user_id = $(this).data('user-id');
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'add_favorite', record_id: record_id, user_id: user_id},
            function (data, textStatus, jqXHR) {
                if( data.status ) {
                    $('[data-record-id='+record_id+']').addClass('in-favorites');
                    $('[data-record-id='+record_id+'] span').html('Добавлено в избранное');
                } else {
                    // $.magnificPopup.open({
                    //     items: {
                    //         src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>'+data.message+'</h2><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                    //         type: 'inline'
                    //     },
                    //     removalDelay: 500,
                    //     callbacks: {
                    //         beforeOpen: function() {
                    //             this.st.mainClass = 'mfp-move-from-top';
                    //         }
                    //     }
                    // });
                }
            },
            "json"
        );
    });
    $('.js-remove-favorite').click(function (e) {
        e.preventDefault();
        var record_id = $(this).data('record-id');
        var user_id = $(this).data('user-id');
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'delete_favorite', record_id: record_id, user_id: user_id},
            function (data, textStatus, jqXHR) {
                if( data.status ) {
                    $('[data-id='+data.id+']').remove();
                }
            },
            "json"
        );
    });
    $('.favs_more').click(function (e) {
        e.preventDefault();
        favsShow = favsShow + favsStep;
        if( favsShow >= favsCnt )
            $('.favs_more').remove();

        for( var i = 0; i < favsShow; i++ )
        {
            $('.favorites .favorite-card').eq(i).removeClass('hidden_item');
        }
    });
    // cart
    $('.good-favorite').click(function (e) {
        e.preventDefault();
        var record_id = $(this).data('record-id');
        var user_id = $(this).data('user-id');
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'add_cart', record_id: record_id, user_id: user_id},
            function (data, textStatus, jqXHR) {
                if( data.status ) {
                    $('[data-record-id='+record_id+']').addClass('in-favorites');
                    $('[data-record-id='+record_id+'] span').html('Добавлено в избранное');
                } else {
                    // $.magnificPopup.open({
                    //     items: {
                    //         src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>'+data.message+'</h2><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                    //         type: 'inline'
                    //     },
                    //     removalDelay: 500,
                    //     callbacks: {
                    //         beforeOpen: function() {
                    //             this.st.mainClass = 'mfp-move-from-top';
                    //         }
                    //     }
                    // });
                }
            },
            "json"
        );
    });
    $('body').on("click", ".scroll_to", function (e) {
        e.preventDefault();
        anc = $(e.target).attr('href').replace('#', '');
        $target_el = $('a[name="' + anc + '"]');
        if ($target_el.length <= 0) {
            $target_el = $('#' + anc);
        }
        var k = 0;
        k += parseInt($target_el.css('margin-top')) + parseInt($target_el.css('padding-top'));
        $('html, body').animate({ scrollTop: $target_el.offset().top - k - 41}, 1200);
    })
    $('.js-remove-good').click(function (e) {
        e.preventDefault();
        var record_id = $(this).data('record-id');
        var user_id = $(this).data('user-id');
        $.post(
            "/local/templates/main/include/ajax.php",
            {action: 'delete_cart', record_id: record_id, user_id: user_id},
            function (data, textStatus, jqXHR) {
                if( data.status ) {
                    $('[data-id='+data.id+']').remove();
                }
            },
            "json"
        );
    });
    $('.cart_more').click(function (e) {
        e.preventDefault();
        var section = $(this).data('section');
        goodsShow[section] = goodsShow[section] + goodsStep[section];
        if( goodsShow[section] >= goodsCnt[section] )
            $('.cart_more[data-section='+section+']').remove();

        for( var i = 0; i < goodsShow[section]; i++ )
        {
            $('.form-section-'+section+' .favorite-card').eq(i).removeClass('hidden_item');
        }
    });

    // search by tag
    $('.tags-ratings-more').click(function (e) {
        e.preventDefault();
        tagsRatingsShow = tagsRatingsShow + tagsRatingsStep;
        if( tagsRatingsShow >= tagsRatingsCnt )
            $('.tags-ratings-more').remove();

        for( var i = 0; i < tagsRatingsShow; i++ )
        {
            $('.tags-ratings-item').eq(i).removeClass('hidden_item');
        }
    });
    $('.tags-articles-more').click(function (e) {
        e.preventDefault();
        tagsArticlesShow = tagsArticlesShow + tagsArticlesStep;
        if( tagsArticlesShow >= tagsArticlesCnt )
            $('.tags-articles-more').remove();

        for( var i = 0; i < tagsArticlesShow; i++ )
        {
            $('.tags-articles-item').eq(i).removeClass('hidden_item');
        }
    });
    $('.tags-news-more').click(function (e) {
        e.preventDefault();
        tagsNewsShow = tagsNewsShow + tagsNewsStep;
        if( tagsNewsShow >= tagsNewsCnt )
            $('.tags-news-more').remove();

        for( var i = 0; i < tagsNewsShow; i++ )
        {
            $('.tags-news-item').eq(i).removeClass('hidden_item');
        }
    });

    // search goods
    $('.search-more-goods').click(function (e) {
        e.preventDefault();
        sGoodsShow = sGoodsShow + sGoodsStep;
        if( sGoodsShow >= sGoodsCnt )
            $('.search-more-goods').remove();

        for( var i = 0; i < sGoodsShow; i++ )
        {
            $('.search-good-item').eq(i).removeClass('hidden_item');
        }
    });
    // search ratings
    $('.search-more-ratings').click(function (e) {
        e.preventDefault();
        sRatingsShow = sRatingsShow + sRatingsStep;
        if( sRatingsShow >= sRatingsCnt )
            $('.search-more-ratings').remove();

        for( var i = 0; i < sRatingsShow; i++ )
        {
            $('.search-rating-item').eq(i).removeClass('hidden_item');
        }
    });
    // search articles
    $('.search-more-articles').click(function (e) {
        e.preventDefault();
        sArticlesShow = sArticlesShow + sArticlesStep;
        if( sArticlesShow >= sArticlesCnt )
            $('.search-more-articles').remove();

        for( var i = 0; i < sArticlesShow; i++ )
        {
            $('.search-article-item').eq(i).removeClass('hidden_item');
        }
    });
    // search news
    $('.search-more-news').click(function (e) {
        e.preventDefault();
        sNewsShow = sNewsShow + sNewsStep;
        if( sNewsShow >= sNewsCnt )
            $('.search-more-news').remove();

        for( var i = 0; i < sNewsShow; i++ )
        {
            $('.search-news-item').eq(i).removeClass('hidden_item');
        }
    });

   product_row_autoheight(".product-row .card");
   product_row_autoheight(".swiper-container .card");
});

function product_row_autoheight(selector){

	var mh = 0;
	element = $(selector).filter(function(elem) {
		return !$(this).parents(".mega-menu").length
	});
	if(element.length>0) {
		element.height('auto');
		$(element).each(function () {
			$(this).find('.card-title.with-text, .card-title.with-text span').height('auto');
			$(this).find('.card-title').css({'height': 'auto'});
			$(this).find('.card-info').css({'position': 'absolute', 'left': '20px', 'bottom': '20px', 'right': '20px'});
			if(!$(this).closest('.article-card').length){
				$(this).find('.card-title').css({'margin-bottom': $(this).find('.card-info').height()+10});
			}
			var h_block = parseInt($(this).height());
			if(h_block > mh) {
				mh = h_block;
			};
		});
		$(element).height(mh);
		//$(".product-row .card-features").height(mh-5);
	}
}
$(document).on('click', '.more-products, .sidebar-widget input, .sidebar-widget select', function (e) {
	setTimeout(function () {
        product_row_autoheight(".product-row .card")
    }, 100);
});

$(document).on('click', '#popup-loginRegister', function (e) {
    $(this).magnificPopup({
        removalDelay: 500,
        midClick: !0,
        fixedContentPos: !1,
        callbacks: {
            beforeOpen: function() {
                this.st.mainClass = this.st.el.attr("data-effect")
            }
        }
    }).magnificPopup('open')
});

$(window).on('resize', function(){
    product_row_autoheight(".product-row .card");
    product_row_autoheight(".swiper-container .card");
})

// ---

// restore password
$(document).on('submit', '#lostPassword2', function (e) {
    $('#lostPassword2 input[type=email]').css('border-color','#0c339f');
    var email = $('#lostPassword2 input[type=email]').val();
    var error = false;
    if( email.length == 0 ) {
        error = true;
        $('#lostPassword2 input[type=email]').css('border-color', 'red');
    }

    if( ! error ) {
        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action: 'restore',
                email: email
            },
            function (data) {
                if( data.status ) {
                    $('#lostPassword2 input[type=email]').val('');
                    $.magnificPopup.open({
                        items: {
                            src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>спасибо</h2><p>Инструкция по восстановлению пароля отправлена на ваш адрес электронной почты. <br><br>Не пришло письмо?</p><a href="#" class="lost-password js-lost-password">Отправить ещё раз?</a><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                            type: 'inline'
                        },
                        removalDelay: 500,
                        callbacks: {
                            beforeOpen: function() {
                                this.st.mainClass = 'mfp-move-from-top';
                            }
                        }
                    });
                } else {
                    $.magnificPopup.open({
                        items: {
                            src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>Ошибка восстановления пароля</h2><p>'+data.message+'</p><br><br><a href="#loginRegister" class="js-lost-password-register" data-effect="mfp-move-from-top">Зарегистрируйтесь</a><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                            type: 'inline'
                        },
                        removalDelay: 500,
                        callbacks: {
                            beforeOpen: function() {
                                this.st.mainClass = 'mfp-move-from-top';
                            }
                        }
                    });
                }
            },
            "json"
        );
    }
    return false;
});
$(document).on('click', '.js-lost-password-register', function (e) {
    //$.magnificPopup.close();
    $('#header a.login-link').click();
});

// comments
$(document).on('click', '.more-comments', function (e) {
    e.preventDefault();
    cmntsShow = cmntsShow + cmntsStep;
    if( cmntsShow >= cmntsCnt )
        $('.more-comments').remove();

    for( var i = 0; i < cmntsShow; i++ )
    {
        $('.comment').eq(i).removeClass('hidden_item');
    }
});

$(document).on('click', '.c-reply', function (e) {
    e.preventDefault();
    var reply_to = $(this).data('reply-to');
    $('input[name=replyto]').val(reply_to);
    $('textarea[name=comment]').focus();
    $('textarea[name=comment]').val('Ответ '+ $('[data-item-id='+reply_to+'] .c-author').html() +': ');
});

$(document).on('click', '.comment___button', function (e) {
    e.preventDefault();

    // Форма
    var this_form = $(this).parents('form');
    // Подготовка
    $(this_form).find("input, textarea").removeClass("is___error");
    $(this_form).find('p.error___p').html('');
    // Задаём переменные
    var article_id = $("input[name=article_id]").val();
    var comment = $(this_form).find("textarea[name=comment]").val();
    var is_auth = $("input[name=is_auth]").val();
    var reply_to = $('input[name=replyto]').val();

    var error = false;
    // Проверки
    if( is_auth == 'Y' ){
        if ( comment.length == 0 ){
            error = ['comment',   'Введите, пожалуйста, текст комментария!'];
        }
    } else {
        //error = [false,   'Для комментирования необходимо авторизоваться на сайте'];
        $('#loginRegister ul li').eq(0).addClass('active');
        $('#loginRegister ul li').eq(1).removeClass('active');
        $('#loginRegister #login').addClass('active');
        $('#loginRegister #register').removeClass('active');
        $.magnificPopup.open({
            items: {src: '#loginRegister'},
            callbacks: {
                beforeOpen: function() {
                    this.st.mainClass = 'mfp-move-from-top';
                }
            }
        });
        return false;
    }
    // Если нет ошибок
    if (!error){

        $.post(
            "/local/templates/main/include/ajax.php",
            {
                action:"add_comment", comment:comment, article_id:article_id, reply_to:reply_to, start_page_size: cmntsCnt
            },
            function(data){
            if (data.status == 'ok'){

                if( data.isAdmin && data.isAdmin=='N' ){

                    $.magnificPopup.open({
                        items:{
                            src:'<div class="mfp-with-anim main-popup login-popup submited"><h2>Успешная отправка!</h2><span class="btn  mfp-close">×</span><p>Комментарий появится на сайте после его модерации</p></div>',
                            type:"inline"
                        }
                        ,removalDelay:500,
                        callbacks:{beforeOpen:function(){this.st.mainClass="mfp-move-from-top"}}
                    })

                }

                $('.comments').replaceWith(data.html);

            } else if (data.status == 'error'){
                show_error(data.text);
            }
        }, 'json')
            .fail(function(data, status, xhr){
                show_error("Ошибка запроса");
            })
            .always(function(data, status, xhr){
                //process(false);
            })
        // Ошибка
    } else {
        $('.comments .error___p').html(error[1]);
    }
});



// compare remove one
$(document).on('click', '.compare-wrapper .swiper-slide .icon-delete', function (e) {
    e.preventDefault();
    var good_id = $(this).data('id');
    var rating_id = $('.rating-id').data('rating-id');
    $.post(
        "/local/templates/main/include/ajax.php",
        {
            action: 'compare_delete',
            rating_id: rating_id,
            good_id: good_id
        },
        function (data) {
            if( data.status ) {

                $('[data-slide-id='+good_id+']').remove();
                $('.compare-meta span').eq(0).html(data.data+' в сравнении');

            } else {

            }
        },
        "json"
    );
    return false;
});

// compare clear all
$(document).on('click', '.clear-all-goods', function (e) {
    e.preventDefault();
    var rating_id = $('.rating-id').data('rating-id');
    $.post(
        "/local/templates/main/include/ajax.php",
        {
            action: 'compare_clear',
            rating_id: rating_id
        },
        function (data) {
            if( data.status ) {

                $('.compare-wrapper .swiper-slide').remove();
                $('.compare-meta span').eq(0).html('0 товаров в сравнении');

            } else {

            }
        },
        "json"
    );
    return false;
});

// compare popup
$(document).on('click', '.js-compare-popup-2', function (e) {
    e.preventDefault();
    var rating_id = $('.rating-id').data('rating-id');
    $.post(
        "/local/templates/main/include/ajax.php",
        {
            action: 'compare_popup',
            rating_id: rating_id
        },
        function (data) {
            if( data.status ) {

                $('#comparePopup').html(data.data);

                $.magnificPopup.open({
                    items: {
                        src: '#comparePopup',
                        type: 'inline'
                    },
                    removalDelay: 500,
                    callbacks: {
                        beforeOpen: function() {
                            this.st.mainClass = 'mfp-move-from-top';
                        }
                    }
                });
                function initCompareSwiper(item, slides) {
                    item.each(function (index, element) {
                        var $this = $(this);
                        $this.addClass("compare-swiper-" + index);
                        $this.parent().find(".button-wrap .swiper-button-prev").addClass("btn-prev-" + index);
                        $this.parent().find(".button-wrap .swiper-button-next").addClass("btn-next-" + index);
                        $this.parent().find(".swiper-pagination").addClass("pagination-" + index);
                        var swiper = new Swiper(".compare-swiper-" + index, {
                            slidesPerView: slides,
                            navigation: {
                                nextEl: ".compare-slider .btn-next-" + index,
                                prevEl: ".compare-slider .btn-prev-" + index,
                            },
                            spaceBetween: 0,
                            breakpoints: {
                                767: {
                                    slidesPerView: 1
                                },
                                992: {
                                    slidesPerView: 2,
                                },
                                1200: {
                                    spaceBetween: 30,
                                    slidesPerView: slides,
                                }
                            },
                            on: {
                                init: function () {
                                    if ($this.find('.swiper-slide').length <=1) {
                                        $this.parent().find('.button-wrap').remove();
                                    } else {
                                        $this.parent().find('.button-wrap').addClass('visible');
                                    }
                                },
                            }
                        });
                        swiper.update();
                    });
                };
                initCompareSwiper($(".js-compare-slider .swiper-container"),4);

            } else {

            }
        },
        "json"
    );
});

// Init dropzone avatar
var dropzone_avatar;
function initDropzoneAvatar2(element) {
    element.each(function (index) {
        var $this = $(this);
        $this.attr('id', 'dropzone-avatar2-' + index);

        Dropzone.autoDiscover = false;
        dropzone_avatar = new Dropzone("#dropzone-avatar2-" + index, {
            url: "/local/templates/main/include/avatar.php",
            acceptedFiles: "image/jpeg,image/jpg,image/png",
            dictDefaultMessage: "Обновить фото профиля",
            dictRemoveFile: "Удалить",
            uploadMultiple: false,
            thumbnailWidth: null,
            thumbnailHeight: null,
            addRemoveLinks: true,
            init: function() {
                this.on("addedfile", function() {
                    if (this.files[1]!=null){
                        this.removeFile(this.files[0]);
                    }
                });
            }
        });

    });
};
initDropzoneAvatar2($('.dropzone-avatar2'));

$('#offerForm input[name=reqOffer]').on('change',  function(){
    if( !$(this).prop('checked') ) {
        $('#offerForm input[type=submit]').prop('disabled', true);
    } else {
        $('#offerForm input[type=submit]').prop('disabled', false);
    }
});
$('#offerForm').validate({
    highlight: function (element) {
        $(element).parent().addClass("field-error");
        $(element).addClass("error");
    },
    unhighlight: function (element) {
        $(element).removeClass("error");
        $(element).parent().removeClass("field-error");
    },
    submitHandler: function(form) {
        var data;
        data = new FormData(form);
        form.classList.add('loading');
        $.ajax({
            url: '/local/templates/main/include/ajax.php',
            type: 'POST',
            data: data,
            contentType: false,
            cache: false,
            processData: false
        }).done(function(data) {
            var text = '';
            if( data.status ) {
                text = "Предложение успешно отправлено";
                $('#offerForm textarea').val('');
                $('input[name=fileId]').val('');
                dropzone.removeAllFiles();
                ym(31284483,'reachGoal','product_research');
            } else {
                text = data.message;
            }
            $.magnificPopup.open({
                items: {
                    src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>'+text+'</h2><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                    type: 'inline'
                },
                removalDelay: 500,
                callbacks: {
                    beforeOpen: function() {
                        this.st.mainClass = 'mfp-move-from-top';
                    }
                }
            });
        }).always(function() {
            form.classList.remove('loading');
        });

        return false; // required to block normal submit since you used ajax
    }
});

// Init dropzone file upload
var dropzone;
function initDropzoneFile2(element) {
    element.each(function (index) {
        var $this = $(this);
        $this.attr('id', 'dropzone-file2-' + index);

        Dropzone.autoDiscover = false;
        dropzone = new Dropzone("#dropzone-file2-" + index, {
            url: "/local/templates/main/include/file.php",
            acceptedFiles: "image/jpeg,image/jpg,image/png,application/msword,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            dictDefaultMessage: "Прикрепить документ",
            dictRemoveFile: "Удалить",
            uploadMultiple: false,
            thumbnailWidth: null,
            thumbnailHeight: null,
            addRemoveLinks: true,
            init: function() {
                this.on("addedfile", function() {
                    if (this.files[1]!=null){
                        this.removeFile(this.files[0]);
                    }
                });
                this.on("success", function(file, serverResponse) {
                    if( serverResponse.status ) {
                        $('input[name=fileId]').val(serverResponse.data);
                    }
                });
            }
        });

    });
};
initDropzoneFile2($('.dropzone-file2'));

// Форма Задать Вопрос, также используется для consumer_rights виджета
$(document).on('click', '.non-auth input, .non-auth textarea', function (e) {
    e.preventDefault();
    var userID = $("input[name=userid]").val();
    if(!userID){
        $('#loginRegister ul li').eq(0).addClass('active');
        $('#loginRegister ul li').eq(1).removeClass('active');
        $('#loginRegister #login').addClass('active');
        $('#loginRegister #register').removeClass('active');
        $.magnificPopup.open({
            items: {src: '#loginRegister'},
            callbacks: {
                beforeOpen: function() {
                    this.st.mainClass = 'mfp-move-from-top';
                }
            }
        });
        return false;
    }
});
$('#helpForm input[name=reqOffer]').on('change',  function(){
    if( !$(this).prop('checked') ) {
        $('#helpForm input[type=submit]').prop('disabled', true);
    } else {
        $('#helpForm input[type=submit]').prop('disabled', false);
    }
});
$('#helpForm').validate({
    highlight: function (element) {
        $(element).parent().addClass("field-error");
        $(element).addClass("error2");
    },
    unhighlight: function (element) {
        $(element).removeClass("error2");
        $(element).parent().removeClass("field-error");
    },
    submitHandler: function(form) {
        var data;
        data = new FormData(form);
        form.classList.add('loading');
        $.ajax({
            url: '/local/templates/main/include/ajax.php',
            type: 'POST',
            data: data,
            contentType: false,
            cache: false,
            processData: false
        }).done(function(data) {
            var text = '';
            var subs_status = '';
            if( data.status ) {
                if (typeof data['subs_status'] != 'undefined')
                    subs_status = '<p>' + data['subs_status'] + '</p>';
                text = "Вопрос успешно отправлен";
                $('#helpForm textarea').val('');
                $('input[name=fileId]').val('');
                dropzone.removeAllFiles();
                ym(31284483,'reachGoal', $('#helpForm').data('form_type'));
            } else {
                text = data.message;
            }
            $.magnificPopup.open({
                items: {
                    src: '<div class="mfp-with-anim main-popup login-popup submited"><h2>'+text+'</h2>'+subs_status+'<span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
                    type: 'inline'
                },
                removalDelay: 500,
                callbacks: {
                    beforeOpen: function() {
                        this.st.mainClass = 'mfp-move-from-top';
                    }
                }
            });
        }).always(function() {
            form.classList.remove('loading');
        });

        return false; // required to block normal submit since you used ajax
    }
});


function searchAutocomplete2() {
    var options = {
        url: function(phrase) {
            return "/local/templates/main/include/search.php?phrase=" + phrase + "&format=json";
        },

        getValue: "name",
        minCharNumber: 3,

        list: {
            match: {
                enabled: true
            }
        },

        theme: "square"
    };

    $("#headerSearch input[name='q']").easyAutocomplete(options);
}
searchAutocomplete2();

function show_error(text) {
    $.magnificPopup.open({
        items: {
            src: '<div class="mfp-with-anim main-popup login-popup submited"><h2 style="color: red;">'+text+'</h2><span class="btn  mfp-close">×</span>   </div>', // can be a HTML string, jQuery object, or CSS selector
            type: 'inline'
        },
        removalDelay: 500,
        callbacks: {
            beforeOpen: function() {
                this.st.mainClass = 'mfp-move-from-top';
            }
        }
    });
}

function initRatingsLatestSlider(n, t){
    //var n = $(".js-ratings_latest-slider .swiper-container");
    //var t = 6;
    n.addClass("ratings_latest-swiper"),
    n.parent().find(".button-wrap .swiper-button-prev").addClass("btn-prev"),
    n.parent().find(".button-wrap .swiper-button-next").addClass("btn-next"),
    n.parent().find(".swiper-pagination").addClass("pagination"),
    new Swiper(".ratings_latest-swiper", {
        slidesPerView: t,
        navigation: {
            nextEl: ".article-slider .btn-next",
            prevEl: ".article-slider .btn-prev"
        },
        pagination: {
            el: ".pagination",
            clickable: !0
        },
        spaceBetween: 30,
        breakpoints: {
            560: {
                slidesPerView: 1,
                spaceBetween: 10
            },
            767: {
                slidesPerView: 2
            },
            992: {
                slidesPerView: 3
            },
            1200: {
                spaceBetween: 30
            }
        },
        on: {
            init: function () {
                n.find(".swiper-slide").length <= 1 ? n.parent().find(".button-wrap").remove() : n.parent().find(".button-wrap").addClass("visible")
            }
        }
    })
}


function removeBanner(){
    $(document).mouseup(function (e){
        var div = $(".subscribeBlockFixed");
        if (!div.is(e.target)
            && div.has(e.target).length === 0) {
            div.remove();
        }
    });
}

function hideArticleSubscrOnly(){
    if($("#subscrPopup_container").length>0){
        $("html").removeClass("subscribers_only");
        $("#subscrPopup_bg").hide().next(".mfp-wrap").hide();
    }
}

function addCloseSidebarSubscBtn(){
    if (typeof Cookies !== 'undefined'){
        if (Cookies.get('subscribeEmail') && $(".subscribeBlock").length>0){
            $(".subscribeBlock .mfp-close").show();
        }
    }
}

$(document).ready(function() {
    if($("#subscribeBlock_mobile .subscribeBlock").length > 0 && $(".sidebar").length > 0){
        $("#subscribeBlock_mobile .subscribeBlock").eq(0).clone(true).appendTo(".sidebar");
    }

    if($(".subscribeBlockFixed").length > 0){
        var wHeight = $(document).height(),
            footerHeight = $("#footer").outerHeight(),
            readMoreHeight = $("#readMore").length > 0 ? $("#readMore").outerHeight() : "0",
            showSubscribeHeight = (wHeight/3)*2 - footerHeight - readMoreHeight;

        $(window).scroll(function showSubscribe() {
          if($(window).scrollTop() > showSubscribeHeight){
            $(".subscribeBlockFixed").fadeIn(500);
          }
        return showSubscribe;
      }());

      if ($(window).width() < '992'){
            removeBanner()
                return this;
        }
    }

    addCloseSidebarSubscBtn();

    if (typeof Cookies !== 'undefined'){

        if (Cookies.get('subscribeEmail') || Cookies.get('close_subscribe')){
            setTimeout(function () {
                hideArticleSubscrOnly();
            }, 1000);
        } else {
            if($("#subscrPopup_container").length>0){
                setTimeout(function () {
                    $("html").addClass("subscribers_only");
                    $("#subscrPopup_bg").show().next(".mfp-wrap").show();
                }, 500);
            }
        }
    }

});

$(".subscribeBlockFixed .mfp-close").on("click", function(){
    $(this).closest(".subscribeBlockFixed").remove();
    Cookies.set('close_subscribe', true, { expires: 2 });
})
$(".subscribeBlock .mfp-close").on("click", function(){
    $(this).closest(".subscribeBlock").remove();
    Cookies.set('close_subscribe', true, { expires: 2 });
})

$(window).resize(function() {
    if ($(window).width() < '992'){
        removeBanner()
            return this;
    }
});


function translit(word){
    var converter = {
        'а': 'a',    'б': 'b',    'в': 'v',    'г': 'g',    'д': 'd',
        'е': 'e',    'ё': 'e',    'ж': 'zh',   'з': 'z',    'и': 'i',
        'й': 'y',    'к': 'k',    'л': 'l',    'м': 'm',    'н': 'n',
        'о': 'o',    'п': 'p',    'р': 'r',    'с': 's',    'т': 't',
        'у': 'u',    'ф': 'f',    'х': 'h',    'ц': 'c',    'ч': 'ch',
        'ш': 'sh',   'щ': 'sch',  'ь': '',     'ы': 'y',    'ъ': '',
        'э': 'e',    'ю': 'yu',   'я': 'ya'
    };

    word = word.toLowerCase();

    var answer = '';
    for (var i = 0; i < word.length; ++i ) {
        if (converter[word[i]] == undefined){
            answer += word[i];
        } else {
            answer += converter[word[i]];
        }
    }

    answer = answer.replace(/[^-0-9a-z]/g, '-');
    answer = answer.replace(/[-]+/g, '-');
    answer = answer.replace(/^\-|-$/g, '');
    return answer;
}

$(document).ready(function() {

    if ($('.table-of-contents.automatic').length) {
        if($('.page-text-detail h2').length > 0) {
            $('.page-text-detail h2').each(function() {
                var ftoc_val = $(this).text().trim();
                var ftoc_hash = translit(ftoc_val).substring(0, 20);
                $(this).attr('id', ftoc_hash);
                $('.table-of-contents.automatic ul.list').append('<li><a class="scroll_to" href="#' + ftoc_hash + '">' + ftoc_val + '</a></li>');
            });

            TableOfContentAutoView();

            $('.table-of-contents.automatic').show();
        }

        $('.table-of-contents .title').click(function () {
            var block = $(this).parent();
            if(block.hasClass('expand')) {
                block.removeClass('expand');
            } else {
                block.addClass('expand');
            }
        });
    }

});

$(window).resize(function () {
    TableOfContentAutoView();
});

function TableOfContentAutoView() {
    if($(window).width() >= 992) {
        $('.table-of-contents').addClass('expand');
    } else {
        $('.table-of-contents').removeClass('expand');
    }
}